const cds = global.cds || require('@sap/cds/lib')

const txUtils = require('../utils/tx')

/*
 * Start of an atomicity group of $batch
 */
const start = (odataContext, done) => {
  if (!odataContext.applicationData.roots) {
    odataContext.applicationData.roots = {}
  }

  odataContext.applicationData.roots[odataContext.id] = cds.context = new cds.Request({
    user: odataContext.applicationData.req.user
  })

  done()
}

/*
 * End of an atomicity group of $batch
 */
const end = async (odataErr, odataContext, done) => {
  const root = odataContext.applicationData.roots[odataContext.id]
  const errors = odataErr || odataContext.failedRequests.length > 0

  try {
    if (errors) {
      // REVISIT: root.emit('failed') with @sap/cds^4.2
      await txUtils.rollback(root)
    } else {
      // REVISIT: root.emit('succeeded') with @sap/cds^4.2
      await txUtils.commit(root)
    }
  } catch (e) {
    if (!errors) {
      try {
        // REVISIT: root.emit('failed') with @sap/cds^4.2
        await txUtils.rollback(root)
      } catch (e1) {
        // > rollback failed... REVISIT: what to do?
      }
    }

    // here, some transactions may have been committed
    return done(e)
  }

  done()
}

module.exports = {
  start,
  end
}
